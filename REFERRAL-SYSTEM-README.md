# Реферальная система для сайта Aida.kg

Эта реферальная система позволяет пользователям приглашать друзей и получать вознаграждение за их заказы. Система поддерживает 3 уровня рефералов с разными процентами вознаграждения:

- **Уровень 1**: 30% от суммы заказа
- **Уровень 2**: 10% от суммы заказа
- **Уровень 3**: 5% от суммы заказа

## Структура проекта

- `referral-routes.js` - API эндпоинты для работы с реферальной системой
- `tilda-referral-system.js` - Клиентский скрипт для интеграции на сайт Tilda
- `referral-system-setup.sql` - SQL-скрипт для настройки базы данных Supabase
- `referral-page-template.html` - HTML-шаблон для страницы реферальной программы
- `referral-system-integration-guide.md` - Инструкция по интеграции на сайт Tilda
- `.env.referral` - Пример файла с переменными окружения

## Функциональность

### Серверная часть

1. **Регистрация с реферальным кодом**
   - Эндпоинт: `/referral/register-with-referral`
   - Метод: POST
   - Параметры: email, name, referralCode
   - Описание: Регистрирует нового пользователя с указанным реферальным кодом

2. **Получение информации о реферальной программе**
   - Эндпоинт: `/referral/referral-info`
   - Метод: POST
   - Параметры: email
   - Описание: Возвращает информацию о реферальной программе пользователя (баланс, рефералы, транзакции)

3. **Начисление реферальных вознаграждений**
   - Эндпоинт: `/referral/process-referral-payment`
   - Метод: POST
   - Параметры: email, amount, description
   - Описание: Начисляет реферальные вознаграждения всем рефералам в цепочке

### Клиентская часть

1. **Сохранение реферального кода**
   - Автоматически сохраняет реферальный код из URL-параметра `ref` в localStorage
   - Обновляет все ссылки на странице, добавляя реферальный код

2. **Перехват форм регистрации**
   - Перехватывает отправку форм с полем email
   - Автоматически регистрирует пользователя с сохраненным реферальным кодом

3. **Отображение реферальной информации**
   - Отображает реферальный код, баланс, количество рефералов и другую информацию
   - Предоставляет возможность копирования реферальной ссылки

4. **Виджет реферальной программы**
   - Создает виджет с информацией о реферальной программе
   - Позволяет пользователю быстро получить доступ к своей реферальной ссылке

## База данных

### Таблица users

Дополнительные поля для таблицы пользователей:

- `referral_code` - уникальный реферальный код пользователя
- `referred_by` - реферальный код пользователя, который пригласил текущего пользователя
- `balance_kgs` - баланс пользователя в KGS
- `total_earned` - общая сумма заработанных денег
- `level_1_referrals` - количество прямых рефералов (1 уровень)
- `level_2_referrals` - количество рефералов 2 уровня
- `level_3_referrals` - количество рефералов 3 уровня

### Таблица referral_transactions

Таблица для отслеживания реферальных транзакций:

- `id` - уникальный идентификатор транзакции
- `user_id` - ID пользователя, получившего вознаграждение
- `referrer_id` - ID пользователя, совершившего заказ
- `amount` - сумма вознаграждения
- `level` - уровень реферальной программы (1, 2 или 3)
- `transaction_date` - дата и время транзакции
- `description` - описание транзакции
- `status` - статус транзакции

## Установка и настройка

1. Настройте базу данных Supabase, выполнив SQL-скрипт `referral-system-setup.sql`
2. Скопируйте файл `.env.referral` в `.env` и заполните его своими значениями
3. Добавьте файлы `referral-routes.js` и `tilda-referral-system.js` на сервер
4. Обновите файл `index.js` для подключения маршрутов реферальной системы
5. Перезапустите сервер
6. Следуйте инструкциям в файле `referral-system-integration-guide.md` для интеграции на сайт Tilda

## Тестирование

1. Зарегистрируйтесь на сайте и получите свой реферальный код
2. Скопируйте реферальную ссылку и откройте ее в другом браузере
3. Зарегистрируйтесь как новый пользователь по этой ссылке
4. Проверьте, что новый пользователь отображается в списке рефералов
5. Сделайте тестовый платеж от имени нового пользователя
6. Проверьте, что реферальное вознаграждение начислено правильно

## Дополнительные возможности

- **Вывод средств**: Добавьте возможность вывода заработанных средств на банковский счет или электронный кошелек
- **Уведомления**: Настройте отправку уведомлений о новых рефералах и начислениях
- **Статистика**: Добавьте более подробную статистику и графики для анализа эффективности реферальной программы
- **Промокоды**: Интегрируйте реферальную систему с системой промокодов для дополнительных бонусов