# Инструкция по интеграции реферальной системы на сайт Tilda

## Шаг 1: Настройка базы данных Supabase

1. Войдите в панель управления Supabase
2. Перейдите в раздел "SQL Editor"
3. Создайте новый запрос и вставьте содержимое файла `referral-system-setup.sql`
4. Выполните запрос для обновления структуры базы данных

## Шаг 2: Обновление сервера

1. Убедитесь, что все файлы реферальной системы загружены на сервер:
   - `referral-routes.js`
   - `tilda-referral-system.js`
   - Обновленный `index.js`

2. Перезапустите сервер для применения изменений

## Шаг 3: Интеграция на сайт Tilda

### 3.1. Добавление скрипта реферальной системы

1. Войдите в панель управления Tilda
2. Перейдите к странице, где вы хотите использовать реферальную систему
3. Нажмите на кнопку "Настройки страницы" (шестеренка в верхнем правом углу)
4. Выберите вкладку "Код в HEAD"
5. Вставьте следующий код:

```html
<script src="https://supabase-auth-production-4267.up.railway.app/tilda-referral-system.js"></script>
```

6. Нажмите "Сохранить"

### 3.2. Создание страницы реферальной программы

1. Создайте новую страницу в Tilda для реферальной программы
2. Добавьте блок Zero Block (T123)
3. Откройте редактор Zero Block
4. Вставьте содержимое файла `referral-page-template.html`
5. Нажмите "Сохранить"

### 3.3. Добавление реферальных элементов на другие страницы

Вы можете добавить элементы реферальной системы на любую страницу вашего сайта, используя следующие CSS-классы:

#### Для отображения реферального кода пользователя:
```html
<span class="referral-code"></span>
```

#### Для отображения баланса пользователя:
```html
<span class="referral-balance"></span>
```

#### Для отображения общей заработанной суммы:
```html
<span class="referral-total-earned"></span>
```

#### Для отображения количества рефералов:
```html
<span class="referral-level1-count"></span> <!-- Рефералы 1 уровня -->
<span class="referral-level2-count"></span> <!-- Рефералы 2 уровня -->
<span class="referral-level3-count"></span> <!-- Рефералы 3 уровня -->
<span class="referral-total-count"></span> <!-- Всего рефералов -->
```

#### Для отображения реферальной ссылки:
```html
<a href="#" class="referral-link"></a>
```

#### Для создания кнопки копирования реферальной ссылки:
```html
<button class="copy-referral-link">Копировать ссылку</button>
```

#### Для отображения контента только для авторизованных пользователей:
```html
<div class="user-content">
  Этот контент виден только авторизованным пользователям
</div>
```

#### Для отображения контента только для гостей:
```html
<div class="guest-content">
  Этот контент виден только гостям
</div>
```

## Шаг 4: Настройка обработки платежей

Для начисления реферальных вознаграждений при совершении платежей, вам нужно интегрировать вызов API в процесс обработки платежей:

1. После успешной оплаты отправьте запрос на сервер:

```javascript
fetch('https://supabase-auth-production-4267.up.railway.app/referral/process-referral-payment', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    email: 'email@пользователя.com', // Email пользователя, совершившего платеж
    amount: 1000, // Сумма платежа в KGS
    description: 'Оплата заказа #12345' // Описание платежа
  })
})
.then(response => response.json())
.then(data => {
  console.log('Реферальные вознаграждения начислены:', data);
})
.catch(error => {
  console.error('Ошибка при начислении реферальных вознаграждений:', error);
});
```

2. Этот запрос автоматически начислит вознаграждения всем рефералам в цепочке (30% для первого уровня, 10% для второго уровня, 5% для третьего уровня).

## Шаг 5: Тестирование реферальной системы

1. Откройте ваш сайт в браузере
2. Зарегистрируйтесь или войдите в систему
3. Перейдите на страницу реферальной программы
4. Скопируйте вашу реферальную ссылку
5. Откройте эту ссылку в другом браузере или в режиме инкогнито
6. Зарегистрируйтесь как новый пользователь
7. Проверьте, что новый пользователь отображается в списке ваших рефералов
8. Сделайте тестовый платеж от имени нового пользователя
9. Проверьте, что вам начислено реферальное вознаграждение

## Дополнительные настройки

### Настройка процентов вознаграждения

Если вы хотите изменить проценты вознаграждения, отредактируйте константы в файле `referral-routes.js`:

```javascript
const REFERRAL_LEVELS = {
  LEVEL_1: 0.3, // 30% для первого уровня
  LEVEL_2: 0.1, // 10% для второго уровня
  LEVEL_3: 0.05 // 5% для третьего уровня
};
```

### Настройка внешнего вида виджета

Вы можете настроить внешний вид виджета реферальной программы, отредактировав стили в файле `tilda-referral-system.js`.

### Добавление возможности вывода средств

Для добавления возможности вывода средств вам потребуется создать дополнительные эндпоинты на сервере и интегрировать их с платежной системой.